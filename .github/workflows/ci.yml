---
name: CI
'on':
  pull_request:
  push:
    branches:
      - main
    tags:
      - '*'

jobs:

    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - name: Check out the codebase.
              uses: actions/checkout@v3

            - name: Set up Python 3.
              uses: actions/setup-python@v4
              with:
                  python-version: '3.x'

            - name: Install test dependencies.
              run: pip3 install yamllint ansible-lint

            - name: Run YAML Lint.
              run: yamllint .

            - name: Run ansible-lint.
              run: ansible-lint ./roles/

    molecule:
        name: Molecule
        runs-on: ubuntu-latest
        strategy:
            matrix:
                distro:
                    - ubuntu2204

        steps:
            - name: Check out the codebase.
              uses: actions/checkout@v3

            - name: Set up Python 3.
              uses: actions/setup-python@v4
              with:
                  python-version: '3.x'

            - name: Install test dependencies.
              run: pip3 install ansible molecule molecule-plugins[docker] docker

            - name: Run Molecule tests.
              run: molecule test
              env:
                  PY_COLORS: '1'
                  ANSIBLE_FORCE_COLOR: '1'
                  MOLECULE_DISTRO: ${{ matrix.distro }}

    release:
      if: ${{ github.ref_type == 'tag' }}
      needs: [lint, molecule]
      runs-on: ubuntu-latest
      steps:
        - name: Check out the codebase.
          uses: actions/checkout@v3
  
        - name: Set up Python 3.
          uses: actions/setup-python@v4
          with:
              python-version: '3.x'
  
        - name: Install Ansible.
          run: pip3 install ansible-core
  
        - name: Build Collection
          run: ansible-galaxy collection build
    
        - name: Publish Collection to Ansible Galaxy
          run: ansible-galaxy collection publish ./serversideup-spin-*.tar.gz --api-key ${{ secrets.GALAXY_API_KEY }}